name: Release standalone docker image
on:
    push:
        tags:
            - "v*.*.*"
            - "v*.*.*-nightly-*"
            - "v*.*.*-nightly-*.*"

env:
    REGISTRY: ghcr.io

jobs:
    infisical-tests:
        name: Run tests before deployment
        # https://docs.github.com/en/actions/using-workflows/reusing-workflows#overview
        uses: ./.github/workflows/run-backend-tests.yml

    infisical-standalone:
        name: Build infisical standalone image postgres
        runs-on: ubuntu-latest
        needs: [infisical-tests]
        permissions:
            contents: read
            packages: write
            attestations: write
            id-token: write
        steps:
            - name: Extract version from tag
              id: extract_version
              run: echo "::set-output name=version::${GITHUB_REF_NAME}"
            - name: ‚òÅÔ∏è Checkout source
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0
            # - name: üì¶ Install dependencies to test all dependencies
            #   run: npm ci --only-production
            #   working-directory: backend
            - name: version output
              run: |
                  echo "Output Value: ${{ steps.version.outputs.major }}"
                  echo "Output Value: ${{ steps.version.outputs.minor }}"
                  echo "Output Value: ${{ steps.version.outputs.patch }}"
                  echo "Output Value: ${{ steps.version.outputs.version }}"
                  echo "Output Value: ${{ steps.version.outputs.version_type }}"
                  echo "Output Value: ${{ steps.version.outputs.increment }}"
            - name: Save commit hashes for tag
              id: commit
              uses: pr-mpt/actions-commit-hash@v2
            - name: üîß Set up Docker Buildx
              uses: docker/setup-buildx-action@v2
            - name: üêã Login to Docker Hub
              uses: docker/login-action@v2
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}
            - name: Build and push Docker image
              id: push
              uses: docker/build-push-action@v6
              with:
                  context: .
                  push: true
                  tags: |
                      ${{ env.REGISTRY }}/nuttyshrimp/infisical:latest-postgres
                      ${{ env.REGISTRY }}/nuttyshrimp/infisical:${{ steps.commit.outputs.short }}
                      ${{ env.REGISTRY }}/nuttyshrimp/infisical:${{ steps.extract_version.outputs.version }}
                  platforms: linux/amd64,linux/arm64
                  file: Dockerfile.standalone-infisical
                  build-args: |
                      POSTHOG_API_KEY=${{ secrets.PUBLIC_POSTHOG_API_KEY }}
                      INFISICAL_PLATFORM_VERSION=${{ steps.extract_version.outputs.version }}

    # infisical-fips-standalone:
    #     name: Build infisical standalone image postgres
    #     runs-on: ubuntu-latest
    #     needs: [infisical-tests]
    #     steps:
    #         - name: Extract version from tag
    #           id: extract_version
    #           run: echo "::set-output name=version::${GITHUB_REF_NAME}"
    #         - name: ‚òÅÔ∏è Checkout source
    #           uses: actions/checkout@v3
    #           with:
    #               fetch-depth: 0
    #         - name: üì¶ Install dependencies to test all dependencies
    #           run: npm ci --only-production
    #           working-directory: backend
    #         - name: version output
    #           run: |
    #               echo "Output Value: ${{ steps.version.outputs.major }}"
    #               echo "Output Value: ${{ steps.version.outputs.minor }}"
    #               echo "Output Value: ${{ steps.version.outputs.patch }}"
    #               echo "Output Value: ${{ steps.version.outputs.version }}"
    #               echo "Output Value: ${{ steps.version.outputs.version_type }}"
    #               echo "Output Value: ${{ steps.version.outputs.increment }}"
    #         - name: Save commit hashes for tag
    #           id: commit
    #           uses: pr-mpt/actions-commit-hash@v2
    #         - name: üîß Set up Docker Buildx
    #           uses: docker/setup-buildx-action@v2
    #         - name: üêã Login to Docker Hub
    #           uses: docker/login-action@v2
    #           with:
    #               registry: ${{ env.REGISTRY }}
    #               username: ${{ github.actor }}
    #               password: ${{ secrets.GITHUB_TOKEN }}
    #         - name: Build and push Docker image
    #           id: push
    #           uses: docker/build-push-action@v6
    #           with:
    #               push: true
    #               context: .
    #               tags: |
    #                   ${{ env.REGISTRY }}/nuttyshrimp/infisical-fips:latest-postgres
    #                   ${{ env.REGISTRY }}/nuttyshrimp/infisical-fips:${{ steps.commit.outputs.short }}
    #                   ${{ env.REGISTRY }}/nuttyshrimp/infisical-fips:${{ steps.extract_version.outputs.version }}
    #               platforms: linux/amd64,linux/arm64
    #               file: Dockerfile.fips.standalone-infisical
    #               build-args: |
    #                   INFISICAL_PLATFORM_VERSION=${{ steps.extract_version.outputs.version }}
